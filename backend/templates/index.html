{% extends "base.html" %}

{% block title %}Home · {{ app_name }}{% endblock %}

{% block content %}
<section class="hero">
    <h2>Find recipes by ingredients</h2>
    <form action="{{ url_for('home.index') }}" class="search-form" method="get">
        <label for="ingredients">Ingredients (comma separated)</label>
        <div class="autocomplete-wrapper">
            <input
                    autocomplete="off"
                    id="ingredients"
                    name="ingredients"
                    placeholder="e.g., chicken, rice, tomatoes"
                    required
                    type="text"
                    value="{{ ingredients_query or '' }}"
            >
            <div id="autocomplete-list" class="autocomplete-list"></div>
        </div>
        
        <!-- Sorting dropdown -->
        <select name="sort" id="sort">
            <option value="usda_desc" {% if sort=='usda_desc' %}selected{% endif %}>USDA Score (High → Low)</option>
            <option value="usda_asc" {% if sort=='usda_asc' %}selected{% endif %}>USDA Score (Low → High)</option>
            <option value="cal_desc" {% if sort=='cal_desc' %}selected{% endif %}>Calories (High → Low)</option>
            <option value="cal_asc" {% if sort=='cal_asc' %}selected{% endif %}>Calories (Low → High)</option>
        </select>

        <button type="submit">Search</button>
        <a class="clear-button" href="{{ url_for('home.index') }}">Clear</a>
    </form>
</section>

<section class="content">
    {% if recipes is none %}
    <p>Enter ingredients and hit search.</p>
    {% else %}
    <h3>Results for: {{ ingredients_query }} (matched ingredient groups: {{ ingredient_groups }})</h3>
    {% set items = recipes.results.bindings if recipes and recipes.results and recipes.results.bindings else [] %}
    {% if items %}
    <ul>
        {% for r in items %}
        <li>
            <p>{{ r.name.value | replace('"','') }}</p>
            <div class="recipe-meta">
                <span class="chip usda">USDA: {{ r.usdascore.value }}</span>
                <span class="chip cal">Calories: {{ r.calAmount.value }} kcal</span>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No recipes found. Try fewer or different ingredients.</p>
    {% endif %}
    {% endif %}
</section>

<script>
(function() {
    const ingredientsInput = document.getElementById('ingredients');
    const autocompleteList = document.getElementById('autocomplete-list');
    const possibleIngredients = {{ possible_ingredients | tojson | safe }};
    
    let currentFocus = -1;
    
    function getCurrentWord(value, cursorPos) {
        let start = value.lastIndexOf(',', cursorPos - 1) + 1;
        if (start < 0) start = 0;
        const currentWord = value.substring(start, cursorPos).trim();
        return { word: currentWord, start: start };
    }
    
    function filterIngredients(query) {
        if (!query) return [];
        const lowerQuery = query.toLowerCase();
        return possibleIngredients.filter(ing => ing.toLowerCase().includes(lowerQuery)).slice(0, 10);
    }
    
    function showAutocomplete() {
        const value = ingredientsInput.value;
        const cursorPos = ingredientsInput.selectionStart || value.length;
        const { word, start } = getCurrentWord(value, cursorPos);

        autocompleteList.innerHTML = '';
        currentFocus = -1;

        if (!word) {
            autocompleteList.style.display = 'none';
            return;
        }

        const matches = filterIngredients(word);
        if (matches.length === 0) {
            autocompleteList.style.display = 'none';
            return;
        }

        matches.forEach(ingredient => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = '<strong>' + ingredient.substring(0, word.length) + '</strong>' + ingredient.substring(word.length);
            item.addEventListener('click', () => selectIngredient(ingredient, start, cursorPos));
            autocompleteList.appendChild(item);
        });

        autocompleteList.style.display = 'block';
    }
    
    function selectIngredient(ingredient, start, end) {
        const value = ingredientsInput.value;
        const before = value.substring(0, start).trim();
        const after = value.substring(end).trim();
        
        let newValue;
        if (before && after) {
            newValue = before + ', ' + ingredient + ', ' + after;
        } else if (before) {
            newValue = before + ', ' + ingredient + (after ? ', ' + after : '');
        } else {
            newValue = ingredient + (after ? ', ' + after : '');
        }

        ingredientsInput.value = newValue;
        autocompleteList.style.display = 'none';
        ingredientsInput.focus();

        const newPos = before.length + (before ? 2 : 0) + ingredient.length;
        ingredientsInput.setSelectionRange(newPos, newPos);
    }

    function moveFocus(direction) {
        const items = autocompleteList.getElementsByClassName('autocomplete-item');
        if (!items.length) return;

        currentFocus += direction;
        if (currentFocus >= items.length) currentFocus = 0;
        else if (currentFocus < 0) currentFocus = items.length - 1;

        Array.from(items).forEach(item => item.classList.remove('active'));
        if (items[currentFocus]) {
            items[currentFocus].classList.add('active');
            items[currentFocus].scrollIntoView({ block: 'nearest' });
        }
    }

    function selectFocused() {
        const items = autocompleteList.getElementsByClassName('autocomplete-item');
        if (currentFocus >= 0 && items[currentFocus]) items[currentFocus].click();
    }

    // Trigger autocomplete on typing
    ingredientsInput.addEventListener('input', showAutocomplete);

    // Trigger autocomplete on focus only if input already has value
    ingredientsInput.addEventListener('focus', function() {
        if (ingredientsInput.value.trim()) {
            showAutocomplete();
        }
    });

    ingredientsInput.addEventListener('keydown', function(e) {
        if (autocompleteList.style.display === 'block') {
            if (e.key === 'ArrowDown') { e.preventDefault(); moveFocus(1); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); moveFocus(-1); }
            else if (e.key === 'Enter' && currentFocus >= 0) { e.preventDefault(); selectFocused(); }
            else if (e.key === 'Escape') { autocompleteList.style.display = 'none'; currentFocus = -1; }
        }
    });

    document.addEventListener('click', function(e) {
        if (!ingredientsInput.contains(e.target) && !autocompleteList.contains(e.target)) {
            autocompleteList.style.display = 'none';
        }
    });

})();
</script>
{% endblock %}
